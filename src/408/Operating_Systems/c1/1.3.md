---
title: 1.3 操作系统的运行环境
---

## 1. 处理器运行模式

用户态→内核态：由中断引起，==硬件自动完成==

内核态→用户态：执行修改PSW的特权指令

特权指令：不允许用户直接使用的指令

非特权指令：与之相反

需要操作系统接入都会引发中断

只有内核态才可以执行特权指令

用户态下使用特权指令会引发中断

### 1.1 时钟管理

功能：计时、利用时间中断来管理

修改时钟需要在内核态下执行

### 1.2 中断机制

初衷：提高多道程序运行时CPU利用率

后来成为操作系统各项操作的基础

现代操作系统是靠中断驱动的软件

### 1.3 原语

原语位于操作系统的底层，是最接近硬件的部分

其操作只能一气呵成，期间不能被中断(原子性)

## 2. 中断和异常

CPU运行用户程序时==唯一==能进入内核态的方式就是通过中断或异常

中断：来自CPU指令外部的事件，通常用于信息输入/输出

可屏蔽中断：通过改变屏蔽字实现多重中断

不可屏蔽中断：顾名思义

:::tip
每一条指令结束，CPU都会检查是否有中断信号

中断时，由硬件完成：

1. 触发中断
2. 保存CPU状态
3. 加载中断向量表
4. 切换为内核态

其中，PC值由中断隐指令自动保存，通用寄存器内容由操作系统保存，TLB和Cache的内容由硬件机构保存

==这一块不太熟，之后回来再研究研究==

中断处理程序是内核程序，属于操作系统程序，==切换到内核态后才执行==
:::

异常：来自CPU指令内部的事件，如程序的非法操作码、地址越界、运算溢出、虚存缺页等

异常分为故障、自陷和终止

故障：由程序执行中引发的异常

自陷：最典型的就是调试时故意设置的断点

终止：出现了使得CPU无法继续执行的硬件故障，即==致命错误==


## 3. 系统调用

自陷指令也是系统调用，==只能由用户态执行==，执行后进入内核态

自陷指令又称访管指令

应用程序可以直接使用系统调用，也可以通过库函数发起系统调用

保证稳定性和安全性

:::tip
系统调用发生于用户态，但是执行于内核态
:::













