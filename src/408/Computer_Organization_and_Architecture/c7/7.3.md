---
title: 7.3 I/O方式
---

I/O方式指的是计算机系统中进行输入/输出操作的方法

## 1. 程序查询方式

信息交换的控制直接由CPU执行程序实现

主机进行IO操作时，先读取设备的状态，并根据设备状态决定下一步操作究竟是数据传送还是等待

程序查询方式的工作流程如下：

1. CPU执行初始化程序，并预置传送参数
2. 向IO接口发出命令字，启动IO设备
3. 从外设接口读取其状态信息
4. CPU周期或持续查询设备状态，直到外设准备就绪
5. 传送一次数据
6. 修改地址和计数器参数
7. 判断传送是否结束，若未结束跳转至第3步，直到计数器为0

第4步的查询方式可分为如下两个种类：

1. 独占查询：CPU花费100%的时间用于IO操作，此时外设和CPU完全串行工作，几乎不执行其他程序

2. 定时查询：CPU周期性查询接口状态，在保证数据不丢失的前提下，总是等到条件满足才进行一个数据的传送

优点：设计简单，硬件量少

缺点：CPU需花费很多时间来查询和等待，一段时间内只能和一台外设交换信息，效率很低

## 2. ==程序中断方式==

### 2.1 程序中断的基本概念

程序中断是指在计算机执行程序的过程中，出现了某些急需处理的异常情况，<u>CPU暂时中止现行程序</u>，而转去对这些异常情况或特殊请求进行处理，处理完毕后再返回到原程序的断点处，继续执行原程序。

程序中断方式的思想：一旦外设完成数据传送的准备工作，就向CPU发出中断请求。在可以响应中断的条件下，CPU暂时中止正在执行的程序，转去执行中断服务程序为外设服务。在中断服务程序中完成一次数据传送；传送完成后，CPU返回原来的程序

### 2.2 程序中断的工作流程

:::danger
中断响应发生在一条指令结束后

而PMA响应发生在总线周期结束后

注意区别！
:::

#### 2.2.1 中断请求

中断源：请求CPU中断的设备或事件

中断请求标记触发器：当状态为1时，表示中断源有请求

#### 2.2.2 中断响应判优

中断响应优先级是指CPU响应中断请求的先后顺序

中断响应的判优通常是通过硬件排队器或中断查询程序实现的

中断优先级包括响应优先级和处理优先级，响应优先级由硬件线路或查询程序的查询顺序决定，不可动态改变。处理优先级可利用中断屏蔽技术动态调整，以实现多重中断

响应优先级：决定哪个中断请求会优先被处理。主要由硬件管理。

处理优先级：决定一个中断服务程序在执行时是否可以被其他中断打断。主要由软件管理。

#### 2.2.3 CPU响应中断的条件：

+ 中断源有中断请求
+ CPU允许中断及开中断
+ ==一条指令执行完毕==，且没有更紧迫的任务

#### 2.2.4 中断响应过程

属于原子操作

中断隐指令：不是真正的指令，不属于指令系统，它是一种虚拟说法，本质上是==硬件的一系列**自动**操作==

其所完成的操作如下：

1. 关中断
2. 保存断点
3. 引出中断服务程序

:::warning
在中断响应周期中，关中断由中断隐指令来执行
:::

:::tip 异常和中断的差异
异常指令通常没有执行成功，断点是当前指令的地址

中断的断点是下一条指令的地址
:::


#### 2.2.5 中断向量

非向量中断：详见5.5

每个中断源都有一个位移的类型号，每个中断类型号都对应一个中断服务程序，每个中断服务程序都有一个入口地址，就是<u>中断向量</u>

CPU把系统全部是中断向量集中存放到某个区域内，叫做中断向量表

CPU响应中断后，根据类型号计算出对应中断向量的地址，再根据该地址从中断向量表中取出中断服务程序的入口地址

==中断向量地址是中断服务程序的入口地址的地址==

#### 2.2.6 中断处理过程

1. 关中断
2. 保存断点
3. 中断服务程序寻址
4. 保存现场和屏蔽字
5. 执行中断服务程序
6. 恢复现场和屏蔽字
7. 开中断，中断返回

==保存通用寄存器的内容由中断服务程序来进行==

### 2.3 多重中断

在执行中断服务程序前后，进行开、关中断，使中断服务程序期间CPU仍然会被处理新的中断请求

中断处理优先级：多重中断的实际优先级处理次序

每个中断源都有一个屏蔽触发器，1表示屏蔽该中断源的请求，0表示可以正常请求

所有屏蔽触发器组合在一起便构成一个屏蔽字寄存器

屏蔽字寄存器的内容称为屏蔽字

屏蔽字：与优先级有关，至少需要有屏蔽自己的1个"1"

屏蔽字中的"1"越多，优先级越高

屏蔽字中的每位决定每个中断源是否被屏蔽

## 3. DMA方式

==完全由硬件==进行信息传送

降低了CPU在传送数据时的开销

DMA方式适用高速设备，但设备必须具有DMA接口

### 3.1 DMA方式的特点

主存和DMA接口之间有一条直接数据通路

CPU会在==每个机器周期==后检查是否有DMA请求

DMA传送期间，传送与主程序并行工作

==DMA的请求优先级高于非屏蔽中断==

### 3.2 DMA控制器的组成

主要功能：

1. 接受外设发出的DMA请求，并向CPU发出总线请求
2. CPU响应并发出总线响应信号，==DMA接管总线控制权==，进入DMA操作周期
3. 确定地址、长度，自动修改主存地址计数和传送长度信号
4. 规定数据的传送方向，发送读写控制信号，执行数据传送操作
5. ==在DMA操作结束时发出中断信号向CPU报告==

### 3.3 DMA的传送方式

单总线结构中的DMA不会有冲突，三总线结构的DMA才会出现冲突


为了解决冲突，有三种方式：

1. DMA传送时停止CPU访存

优点：控制简单，适用于数据传输速率很高的IO设备

缺点：未发挥CPU对主存的利用率

2. 周期挪用

周期：主存的==存取周期==

在有DMA请求时，若CPU正在访存，则存取周期结束后，CPU将总线占有权让出

若同时请求访存，则DAM优先

优点：既实现了IO传送，又较好地发挥了主存和CPU的效率

缺点：每挪用一个主存周期，DMA接口都要申请、建立、归还总线控制权

3. 交替访存

优点：不需要申请、建立、归还使用总线使用，传送效率高

缺点：硬件逻辑变得复杂



















