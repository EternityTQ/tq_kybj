---
title: 5.6 指令流水线
---

## 1. 基本概念

可以从两个方面来提高处理机的并行性：

1. 时间上的并行技术，将一个任务分解为多个不同的子阶段，每个子阶段在不同的功能部件上并行执行，以便在同一时刻能够执行多个任务，称为**流水线技术**

2. 空间上的并行技术，在一个处理机内设置多个执行相同任务的功能部件，称为**超标量处理机**

一个指令可以分为五个阶段：

1. 取指(IF)：从指令存储器或==指令Cache==中取指令

2. 译码/读寄存器(ID)：操作控制器对指令进行译码，同时从寄存器堆中取操作数，==操作数直接来自于寄存器==

3. 执行/计算地址(EX)：执行运算操作或计算地址

4. 访存(MEM)：对存储器执行读写操作，==此时访问数据Cache==

5. 写回(WB)：将指令执行结果写回寄存器堆

为了利于实现指令流水线，指令集应具有如下特征：

1. 指令长度应尽量一致
2. 指令格式应尽量规整
3. 采用LOAR/STORE型指令
4. 数据和指令在存储器中安边界对齐存放

## 2. 流水线的基本实现


1. 以所有阶段中的最长耗时来设定机器周期
2. 每个流水段后都要增加一个流水段寄存器，用于锁存本段处理完的所有数据，以保证本段的执行结果能在下个时钟周期给下个流水段使用
   
## 3. 流水线的冒险与处理

### 3.1 结构冒险

互斥，也称资源冲突

由不同指令在同一时刻争用同一功能部件而形成的冲突

解决方法：

1. 使用相关指令前暂停一个时钟周期
2. 设置多个重复独立的部件
3. 采用数据Cache和指令Cache分离的方式

### 3.2 数据冒险

同步，也称数据相关

后面指令用到前面指令的结果时，前面指令的结果还未产生

解决方法：

1. 延迟执行相关命令，塞几个空拍子或塞几个空指令进去

2. ==采用转发方法==

不等前一条指令写回寄存器，直接在EX段结束时存放入特殊的EX/MEM流水段寄存器，后面指令可以直接用

3. load-use数据冒险

==load指令后无法使用转发方法解决问题==，原因是load段在WB段才将数据放回寄存器

此时仍然需要采用第一种方法，或者使用编译优化，调整指令顺序

### 3.3 控制冒险

PC值改变时，会引发断流，也称作控制冲突

解决方法：

1. 由转移指令引发的冲突，可以插入空指令或硬件阻塞
2. 进行分支预测
3. 同时预取成功与失败的目标指令
4. 加快和提前形成条件码

## 4. 流水线的性能指标

计算都处于理想情况下：各阶段时间相同、结束后立即进入下阶段

### 4.1 吞吐率

吞吐率是指在单位时间内流水线所完成的任务数量

k:流水段的段数 $\delta t$：时钟周期 n：任务数

$$TP=\frac{n}{(k+n-1)\delta t}$$

### 4.2 加速比

同样完成一批任务，不使用流水线和使用流水线所用时间之比

$$S=\frac{kn\delta t}{(k+n-1)\delta t}$$

### 3. 设备利用率

大矩形/楼梯型面积

## 5. 高级流水线技术

### 1. 超标量流水线技术

空分复用技术，利用编译优化技术，不能调整执行顺序

每个时钟周期内并发多条独立命令

### 2. 超长指令字技术

每个指令呈T型，由编译程序挖掘出指令间潜在的并行性，将多条能并行操作的指令组合成一条具有多个操作码字段的超长指令字，为此需要采用多个处理部件

### 3. 超流水线技术

时分复用技术，对时钟周期再分段




